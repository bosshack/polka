#!/bin/bash
# vim: set ft=sh sw=2 ts=2 expandtab:

set -e

read -n1 -p 'Would you like to update vim bundles? ' answer
echo
if [[ "$answer" != "y" && "$answer" != "Y" ]]; then
  echo "Skipping vim-bundle"
  exit 0
fi

success() {
  echo "$(tput setaf 2)${1}$(tput sgr0)"
}
error() {
  echo "$(tput setaf 1)${1}$(tput sgr0)"
}

get_bundle() {
  (
    if [ -d "$2" ]; then
      cd "${2}"
      (
        git fetch --all -q &>/dev/null
        git rebase -q origin/HEAD &>/dev/null
      )
      if [ $? -eq 0 ]; then
        success "${1}'s ${2} updated"
      else
        error "Error updating ${1}'s ${2}"
      fi
    else
      ( git clone -q "git://github.com/${1}/${2}.git" &>/dev/null )
      if [ $? -eq 0 ]; then
        success "${1}'s ${2} installed"
      else
        error "Error installing ${1}'s ${2}"
      fi
    fi
  )
}

[ -d "${HOME}/.vim/bundles" ] || mkdir -p "${HOME}/.vim/bundles"
cd "${HOME}/.vim/bundles"

# Read each ~/.vim/*.bundle file and install it
for bundle in ${HOME}/.vim/*.bundle; do
  while read owner project; do
    get_bundle $owner $project &
  done < $bundle
  wait
done

vim -c 'call pathogen#helptags()|q'

exit 0
